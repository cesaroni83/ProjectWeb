@page "/DetInput"
@using Microsoft.AspNetCore.Authorization
@using ProjectWeb.ASM.Repositorio
@using ProjectWeb.Shared.Modelo.DTO.Categoria
@using ProjectWeb.Shared.Modelo.DTO.ProductImage
@using ProjectWeb.Shared.Modelo.DTO.Producto
@using ProjectWeb.Shared.Modelo.DTO.TemporalSale
@using ProjectWeb.Shared.Modelo.Estatico
@using ProjectWeb.Shared.Enums

@inject SweetAlertService sweetAlertService
@inject IRepository repository
@inject NavigationManager navigationManager

@attribute [Authorize]
<PageTitle>Informacion Input</PageTitle>


<div class="principal">
    <div class="login-register-container">
        <div class="page-wrapper">
            <div class="form-card">

                <h2 class="form-title"><i class="bi bi-ui-checks-grid"></i> @Titulo</h2>

                <Tabs EnableFadeEffect="true" id="formTab" class="tab-content active">

                    <!-- TAB 1 -->
                    <Tab Title="Informacion Principal" Active="true">
                        <Content>
                            <div class="tab-content-inner">
                                <form>
                                    <!-- Imagen previa -->
                                    <div class="img-preview-container">
                                        <img src="@Input.MainImage" class="img-preview" />
                                    </div>
                                    <div class="form-group mt-3">
                                        <label>Categoria</label>
                                        <div class="input-icon">
                                            <span class="icon"><i class="fas fa-globe"></i></span>
                                            <input type="text" class="form-control" placeholder="Categoria Producto" value="@Input?.Categorias?.Descripcion_Cat" readonly/>
                                         </div>   
                                    </div>
                                    <div class="form-group mt-3">
                                        <label>Descripcion Categoria</label>
                                        <div class="input-icon">
                                            <span class="icon"><i class="fas fa-globe"></i></span>
                                            <textarea rows="2" class="form-control" placeholder="Informacion De Categoria" value="@Input?.Categorias?.Informacion_Cat" readonly/>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>ID Producto</label>
                                            <div class="input-icon">
                                                <i class="bi bi-building"></i>
                                                <input class="form-control" value="@Input?.Id_producto" readonly />
                                            </div>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Nombre Producto</label>
                                            <div class="input-icon">
                                                <i class="bi bi-card-text"></i>
                                                <input class="form-control" value="@Input?.Name" readonly />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group mt-3">
                                        <label>Descripcion Producto</label>
                                        <div class="input-icon">
                                            <span class="icon"><i class="fas fa-globe"></i></span>
                                            <textarea rows="2" class="form-control" placeholder="Informacion De Categoria" value="@Input?.Description" readonly />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Precio</label>
                                            <div class="input-icon">
                                                <i class="bi bi-building"></i>
                                                <input class="form-control" value="@Input?.Price" readonly />
                                            </div>
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Stock</label>
                                            <div class="input-icon">
                                                <i class="bi bi-card-text"></i>
                                                <input class="form-control" value="@Input?.Stock" readonly />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        @if(Input?.Stock>0)
                                        {
                                                <div class="form-group col-md-6">
                                                    <label>Estado</label>
                                                    <div class="input-icon">
                                                        <i class="bi bi-building"></i>
                                                        <input class="form-control" value="Producto Disponible" readonly />
                                                    </div>
                                                </div>
                                        }
                                        else
                                        {
                                                <div class="form-group col-md-6">
                                                    <label>Estado</label>
                                                    <div class="input-icon">
                                                        <i class="bi bi-building"></i>
                                                        <input class="form-control" value="Producto No Disponible" readonly />
                                                    </div>
                                                </div>    
                                        }
                                        <div class="form-group col-md-6">

                                        </div>
                                    </div>
                                </form>
                            </div>
                        </Content>
                    </Tab>

                    <!-- TAB 2 -->
                    <Tab Title="Imagenes">
                        <Content>
                            <div class="tab-content-inner">
                                <div class="carousel-wrapper">

                                    @if (Input?.ProductImages != null && CarouselItems.Count > 0)
                                    {
                                        <Carousel ShowIndicators="true" Autoplay="CarouselAutoPlay.StartOnPageLoad" class="custom-carousel">
                                            @for (int i = 0; i < CarouselItems.Count; i++)
                                            {
                                                var item = CarouselItems[i];
                                                <CarouselItem Active="@(i == 0)">
                                                    <Image Src="@item.Base64Image" Class="carousel-image" />
                                                    <CarouselCaption>
                                                        <div class="carousel-caption-inner">
                                                            <h2>@item.Titulo</h2>
                                                            <p>@item.Descripcion</p>
                                                        </div>
                                                    </CarouselCaption>
                                                </CarouselItem>
                                                

                                            }
                                        </Carousel>
                                    }
                                    else
                                    {
                                        <p>No hay imágenes del producto.</p>
                                    }

                                </div>
                            </div>
                        </Content>
                    </Tab>

                    <!-- TAB 3 -->
                    <Tab Title="Recenciones">
                        <Content>
                            <div class="tab-content-inner">
                                <div class="form-group mt-3">
                                    <label>Apellido</label>
                                    <p class="form-control-plaintext"></p>
                                </div>
                            </div>
                        </Content>
                    </Tab>

                </Tabs>

                <div class="buttons-container">
                    <button type="button" class="btn btn-primary" @onclick="SubmitForm">@SubmitButtonText</button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancel</button>
                </div>

            </div>
        </div>
    </div>
</div>

@code {
    [CascadingParameter] BlazoredModalInstance Modal { get; set; } = default!;
    [Parameter] public int Id_prod { get; set; } = 0;
    [Parameter] public string SubmitButtonText { get; set; } = string.Empty;
    [Parameter] public string Titulo { get; set; } = string.Empty;
    [Inject] ToastService ToastService { get; set; } = default!;
    [Inject] protected PreloadService PreloadService { get; set; } = default!;
    private List<Estado> items = new();
    private ProductoDTO Input { set; get; } = new ProductoDTO();
    private string ImagePrev { set; get; } = string.Empty;
    private string Estados ="A";
    [CascadingParameter] private Task<AuthenticationState> authenticationStateTask { get; set; } = null!;
    // [Inject] private AuthenticationStateProvider AuthProvider { get; set; } = default!;

    private bool isAuthenticated { set; get; }
    private List<CarouselItemData> CarouselItems = new();
    [Parameter] public EventCallback<int> OnCounterChanged { get; set; }


    protected override async Task OnInitializedAsync()
    {
        PreloadService.Show(SpinnerColor.Light, "Loading data...");
        items = Estado.GetItems();
        //await LoadUserAsyc();
        if (Id_prod != 0)
        {
            await GetProducto(Id_prod);
        }
        StateHasChanged();
        PreloadService.Hide();
    }

    private async Task GetProducto(int id)
    {
        var responseHttp = await repository.Get<ProductoDTO>($"/api/Productos/GetProductoWithImagen/{id}");
        if (responseHttp.Error)
        {
            var message = await responseHttp.GetErrorMessageAsync();
            await sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            return;
        }
        Input = responseHttp.Response!;
        // 👇 Llamas a CargaImagenes si la lista existe y tiene elementos
        if (Input.ProductImages != null && Input.ProductImages.Any())
        {
            await CargaImagenes(Input.ProductImages.ToList());
        }
    }

    private async Task CargaImagenes(List<ImagenProdDTO> Lista)
    {
        CarouselItems.Clear();

        foreach (var img in Lista)
        {
            CarouselItems.Add(new CarouselItemData
            {
                Base64Image = img.Foto_Producto!,
                Titulo = img.Name_imagen ?? "",
                Descripcion = img.Descripcion_imagen ?? ""
            });
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task Cancelar()
    {
        await LoadCounterAsync();
        await Modal.CancelAsync();
    }

    private async Task SubmitForm()
    {
        if (SubmitButtonText == "Add")
        {
            await CheckIsAuthenticatedAsync();
            await AddToCartAsync(Id_prod);
            await LoadCounterAsync();
            await Modal.CloseAsync(ModalResult.Ok(Input));
            return;
        }

    }

    private async Task CheckIsAuthenticatedAsync()
    {
        var state = await authenticationStateTask;
        Console.WriteLine("Usuario autenticado: " + state.User.Identity!.IsAuthenticated);
        if (authenticationStateTask is null)
        {
            Console.WriteLine("authenticationStateTask ES NULL");
            isAuthenticated = false;
            return;
        }
        var authenticationState = await authenticationStateTask;
        isAuthenticated = authenticationState.User.Identity!.IsAuthenticated;
       
    }

    private async Task AddToCartAsync(int productId)
    {
        if (!isAuthenticated)
        {
            var toast1 = sweetAlertService.Mixin(new SweetAlertOptions
            {
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                ShowConfirmButton = false,
                Timer = 5000
            });
            await toast1.FireAsync(icon: SweetAlertIcon.Error, message: "Debes haber iniciado sesión para poder agregar productos al carro de compras.");
            await Cancelar();
            navigationManager.NavigateTo("/Login");
            return;
        }

        var temporalSaleDTO = new TemporalSaleDTO
        {
            ProductId = productId
        };

        var httpResponse = await repository.Post("/api/TemporalSales", temporalSaleDTO);
        if (httpResponse.Error)
        {
            var message = await httpResponse.GetErrorMessageAsync();
            await sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            return;
        }
        var toast2 = sweetAlertService.Mixin(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd,
            ShowConfirmButton = false,
            Timer = 5000
        });
        await toast2.FireAsync(icon: SweetAlertIcon.Success, message: "Input agregado al carro de compras.");
        
    }

    private async Task LoadCounterAsync()
    {
        if (!isAuthenticated)
        {
            return;
        }

        var responseHttp = await repository.Get<int>("/api/TemporalSales/count");
        if (responseHttp.Error)
        {
            return;
        }
       var count = responseHttp.Response;
        await OnCounterChanged.InvokeAsync(count);  // Notificamos al padre
    }

}